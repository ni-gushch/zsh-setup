name: Test ZSH Setup Script

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-zsh-setup:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ubuntu-22.04, ubuntu-20.04, debian-11, centos-8, fedora-38]
        include:
          - platform: ubuntu-22.04
            image: ubuntu:22.04
          - platform: ubuntu-20.04
            image: ubuntu:20.04
          - platform: debian-11
            image: debian:11
          - platform: centos-8
            image: centos:8
          - platform: fedora-38
            image: fedora:38

    container:
      image: ${{ matrix.image }}
      options: --privileged

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install basic dependencies
      run: |
        # Install common dependencies for all platforms
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update
          apt-get install -y curl git sudo procps
        elif command -v yum >/dev/null 2>&1; then
          yung install -y curl git sudo procps-ng
        elif command -v dnf >/dev/null 2>&1; then
          dnf install -y curl git sudo procps-ng
        fi

    - name: Make script executable
      run: chmod +x zsh_setup.sh

    - name: Run zsh setup script in headless mode
      run: |
        set -x
        export AUTO_INSTALL=y
        timeout 300 bash -x ./zsh_setup.sh
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 124 ]; then
          echo "‚ùå Script timed out after 5 minutes"
          exit 1
        elif [ $EXIT_CODE -ne 0 ]; then
          echo "‚ùå Script failed with exit code $EXIT_CODE"
          exit $EXIT_CODE
        fi

    - name: Verify installation
      run: |
        echo "=== Running comprehensive verification ==="
        
        # Check basic components
        declare -A checks=(
          ["ZSH installed"]="command -v zsh >/dev/null 2>&1"
          ["Oh My Zsh directory exists"]="test -d ~/.oh-my-zsh"
          ["Powerlevel10k theme exists"]="test -d ~/.oh-my-zsh/custom/themes/powerlevel10k"
          ["zsh-autosuggestions plugin exists"]="test -d ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
          ["zsh-syntax-highlighting plugin exists"]="test -d ~/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
          [".zshrc file exists"]="test -f ~/.zshrc"
          [".zshrc backup exists if needed"]="test -f ~/.zshrc.backup || echo 'No backup needed'"
        )
        
        FAILED=0
        for check_name in "${!checks[@]}"; do
          if eval "${checks[$check_name]}"; then
            echo "‚úÖ $check_name"
          else
            echo "‚ùå $check_name - FAILED"
            FAILED=1
          fi
        done
        
        # Test .zshrc syntax
        if command -v zsh >/dev/null 2>&1 && [ -f ~/.zshrc ]; then
          if zsh -n ~/.zshrc 2>/dev/null; then
            echo "‚úÖ .zshrc syntax is valid"
          else
            echo "‚ùå .zshrc syntax is invalid"
            zsh -n ~/.zshrc || true
            FAILED=1
          fi
        fi
        
        # Test sourcing .zshrc
        if command -v zsh >/dev/null 2>&1 && [ -f ~/.zshrc ]; then
          if zsh -c "source ~/.zshrc && echo 'Sourcing successful' && exit 0" 2>/dev/null; then
            echo "‚úÖ .zshrc can be sourced successfully"
          else
            echo "‚ùå .zshrc sourcing failed"
            FAILED=1
          fi
        fi
        
        # Test basic zsh functionality
        if command -v zsh >/dev/null 2>&1; then
          if zsh -c "echo 'ZSH is working!'" 2>/dev/null; then
            echo "‚úÖ ZSH basic functionality test passed"
          else
            echo "‚ùå ZSH basic functionality test failed"
            FAILED=1
          fi
        fi
        
        if [ $FAILED -eq 0 ]; then
          echo "üéâ All verification tests passed!"
        else
          echo "üí• Some verification tests failed!"
          exit 1
        fi

    - name: Test plugin functionality
      run: |
        echo "=== Testing plugin functionality ==="
        
        if command -v zsh >/dev/null 2>&1 && [ -f ~/.zshrc ]; then
          # Test that plugins are loaded by checking if their functions exist
          if zsh -c "source ~/.zshrc && typeset -f __zsh_autosuggest_bind_widgets >/dev/null 2>&1 && echo '‚úÖ zsh-autosuggestions functions available'"; then
            echo "‚úÖ zsh-autosuggestions plugin is properly loaded"
          else
            echo "‚ö† zsh-autosuggestions plugin functions not found (may be normal for headless)"
          fi
          
          # Test git aliases
          if zsh -c "source ~/.zshrc && alias gst >/dev/null 2>&1 && echo '‚úÖ Git aliases available'"; then
            echo "‚úÖ Git plugin aliases are available"
          else
            echo "‚ùå Git plugin aliases not found"
            exit 1
          fi
        fi

    - name: Show file structure
      if: always()
      run: |
        echo "=== Final file structure ==="
        find ~/.oh-my-zsh -maxdepth 2 -type d -name "custom*" -o -name "themes" -o -name "plugins" | head -20
        echo "---"
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SC2010: –≤–º–µ—Å—Ç–æ ls | grep –∏—Å–ø–æ–ª—å–∑—É–µ–º find
        find ~/ -maxdepth 1 -name "*zsh*" -o -name "*oh-my*" -o -name ".*zsh*" -o -name ".*oh-my*" 2>/dev/null || true

  test-macos:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Homebrew (if not present)
      run: |
        if ! command -v brew >/dev/null 2>&1; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"
        fi

    - name: Make script executable
      run: chmod +x zsh_setup.sh

    - name: Run zsh setup script on macOS
      run: |
        set -x
        export AUTO_INSTALL=y
        ./zsh_setup.sh
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "‚ùå Script failed with exit code $EXIT_CODE"
          exit $EXIT_CODE
        fi

    - name: Verify macOS installation
      run: |
        echo "=== macOS Verification ==="
        
        # Basic checks
        command -v zsh && echo "‚úÖ ZSH installed"
        test -d ~/.oh-my-zsh && echo "‚úÖ Oh My Zsh installed"
        test -f ~/.zshrc && echo "‚úÖ .zshrc exists"
        
        # Test syntax
        zsh -n ~/.zshrc && echo "‚úÖ .zshrc syntax valid"
        
        echo "üéâ macOS test completed successfully"

  test-alpine:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.18
      options: --privileged

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Alpine dependencies
      run: |
        apk update
        apk add bash curl git sudo

    - name: Make script executable
      run: chmod +x zsh_setup.sh

    - name: Test Alpine compatibility (expected to fail gracefully)
      run: |
        set +e
        export AUTO_INSTALL=y
        ./zsh_setup.sh
        EXIT_CODE=$?
        
        # On Alpine, we expect failure due to missing zsh in repositories
        # but the script should handle it gracefully
        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Script handled Alpine gracefully"
        else
          echo "‚ö† Script failed on Alpine (expected for some platforms)"
          # Don't fail the workflow for Alpine - it's a compatibility test
        fi

  report:
    runs-on: ubuntu-latest
    needs: [test-zsh-setup, test-macos, test-alpine]
    if: always()
    steps:
    - name: Generate test report
      run: |
        echo "üìä Test Summary"
        echo "Platform Tests: ${{ needs.test-zsh-setup.result }}"
        echo "macOS Test: ${{ needs.test-macos.result }}"
        echo "Alpine Test: ${{ needs.test-alpine.result }}"
        
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SC2016: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        if [ "${{ needs.test-zsh-setup.result }}" = "success" ] && [ "${{ needs.test-macos.result }}" = "success" ]; then
          echo "üéâ All main tests passed!"
          exit 0
        else
          echo "‚ùå Some tests failed"
          exit 1
        fi